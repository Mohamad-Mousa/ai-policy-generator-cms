<div class="card border-0 shadow-sm h-100">
  <div class="card-body">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
      <div>
        <p class="text-uppercase text-muted fw-semibold small mb-1">Generation</p>
        <h2 class="h4 mb-0">AI Policy Generator</h2>
      </div>
      @if (isGenerated()) {
      <div class="d-flex gap-2">
        <app-button label="Save Policy" size="sm" variant="primary" icon="save" [functionKey]="functionKey"
          [privilegeAccess]="writePrivilege" (click)="savePolicy()"></app-button>
        <app-button label="Export PDF" size="sm" variant="outline" icon="picture_as_pdf" [functionKey]="functionKey"
          [privilegeAccess]="readPrivilege" (click)="exportPolicy('pdf')"></app-button>
        <app-button label="Export DOCX" size="sm" variant="outline" icon="description" [functionKey]="functionKey"
          [privilegeAccess]="readPrivilege" (click)="exportPolicy('docx')"></app-button>
      </div>
      }
    </div>

    <div class="alert alert-info mb-4" role="alert">
      <strong>How it works:</strong> Provide your context and readiness assessment results.
      The system will retrieve relevant international AI policies and generate a customized policy draft
      with citations, rationale, and references tailored to your needs.
    </div>

    @if (showAssessmentsView()) {
    <!-- Assessments Table View -->
    <div class="d-flex align-items-center justify-content-between mb-4">
      <button type="button" class="btn btn-link text-decoration-none p-0 d-flex align-items-center"
        (click)="goBackToSelection()">
        <span class="material-symbols-rounded me-2">arrow_back</span>
        <span>Back to Selection</span>
      </button>
      <app-button [label]="isGenerating() ? 'Generating...' : 'Generate Policy'" size="md" variant="primary"
        icon="auto_awesome" [disabled]="selectedAssessments().length === 0 || isGenerating()"
        [functionKey]="functionKey" [privilegeAccess]="writePrivilege" (click)="generatePolicy()"></app-button>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-4">
          <div>
            <h5 class="mb-1">Completed Assessments</h5>
            <p class="text-muted small mb-0">
              Showing assessments for selected domains
              @if (selectedAssessments().length > 0) {
              <span class="ms-2">
                â€¢ <strong>{{ selectedAssessments().length }}</strong> selected
              </span>
              }
            </p>
          </div>
          <div class="d-flex align-items-center gap-2">
            @if (selectedAssessments().length > 0) {
            <span class="badge bg-success">
              {{ selectedAssessments().length }} selected
            </span>
            }
            <span class="badge bg-primary">
              {{ assessments().length }} assessment{{ assessments().length > 1 ? 's' : '' }}
            </span>
          </div>
        </div>

        @if (assessments().length === 0) {
        <div class="alert alert-info" role="alert">
          <strong>No assessments found:</strong> There are no completed assessments for the selected domains.
        </div>
        } @else {
        <app-table [columns]="assessmentTableColumns" [rows]="assessmentTableRows"
          [totalCount]="assessmentsTotalCount()" [enableFilters]="true" [enableSorting]="true"
          [enableGlobalSearch]="true" [enablePagination]="true" [enableSelection]="true" [selectionKey]="'_id'"
          [selectedRows]="selectedAssessmentIdsForTable" [currentPageInput]="currentPage()"
          [pageSizeInput]="pageLimit()" [loading]="isLoadingAssessments()" emptyMessage="No assessments found"
          (pageChange)="onPageChange($event)" (limitChange)="onLimitChange($event)"
          (selectionChange)="onAssessmentSelectionChange($event)"></app-table>
        }
      </div>
    </div>
    } @else if (!showPreview()) {
    <!-- Policy Context Form -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <h5 class="mb-4">Policy Context</h5>

        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">Domains <span class="text-danger">*</span></label>
            @if (isLoadingDomains()) {
            <div class="text-muted">Loading domains...</div>
            } @else if (!domains().length) {
            <small class="text-muted d-block">
              No active domains available. Please create or enable a domain first.
            </small>
            } @else {
            <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
              @for (domain of domains(); track domain._id) {
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" [id]="'domain-' + domain._id"
                  [checked]="isDomainSelected(domain._id)" [disabled]="isLoadingAssessments()"
                  (change)="toggleDomainSelection(domain._id)" />
                <label class="form-check-label" [for]="'domain-' + domain._id">
                  {{ domain.title }}
                </label>
              </div>
              }
            </div>
            @if (selectedDomainIds.length > 0) {
            <small class="text-muted d-block mt-2">
              {{ selectedDomainIds.length }} domain{{ selectedDomainIds.length > 1 ? 's' : '' }} selected
            </small>
            }
            }
          </div>

          <div class="col-md-6">
            <label class="form-label">Sector <span class="text-danger">*</span></label>
            <select class="form-select" [(ngModel)]="policyContext.sector" [disabled]="isLoadingAssessments()">
              <option value="">Select sector</option>
              @for (option of sectorOptions; track option) {
              <option [value]="option">{{ option }}</option>
              }
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Organization Size <span class="text-danger">*</span></label>
            <select class="form-select" [(ngModel)]="policyContext.organizationSize"
              [disabled]="isLoadingAssessments()">
              <option value="">Select size</option>
              @for (option of sizeOptions; track option) {
              <option [value]="option">{{ option }}</option>
              }
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Risk Appetite <span class="text-danger">*</span></label>
            <select class="form-select" [(ngModel)]="policyContext.riskAppetite" [disabled]="isLoadingAssessments()">
              <option value="">Select risk appetite</option>
              @for (option of riskAppetiteOptions; track option) {
              <option [value]="option">{{ option }}</option>
              }
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Implementation Timeline <span class="text-danger">*</span></label>
            <select class="form-select" [(ngModel)]="policyContext.timeline" [disabled]="isLoadingAssessments()">
              <option value="">Select timeline</option>
              @for (option of timelineOptions; track option) {
              <option [value]="option">{{ option }}</option>
              }
            </select>
          </div>
        </div>

        <div class="mt-4">
          <app-button [label]="isLoadingAssessments() ? 'Loading...' : 'Select Assessments'" size="md" variant="primary"
            icon="assessment" [disabled]="!isFormValid() || isLoadingAssessments()" [functionKey]="functionKey"
            [privilegeAccess]="readPrivilege" (click)="selectAssessments()"></app-button>
        </div>
      </div>
    </div>

    @if (isLoadingAssessments()) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted">Loading completed assessments for selected domains...</p>
    </div>
    }
    } @else {
    <!-- Policy Preview -->
    <div class="policy-preview">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <button type="button" class="btn btn-link text-decoration-none p-0 d-flex align-items-center"
          (click)="editContext()">
          <span class="material-symbols-rounded me-2">arrow_back</span>
          <span>Edit Context</span>
        </button>
      </div>

      @if (selectedDomains().length > 0) {
      <div class="alert alert-primary d-flex align-items-center gap-2 mb-4" role="alert">
        <span class="material-symbols-rounded">category</span>
        <span>
          Generated for
          @if (selectedDomains().length === 1) {
          <strong class="ms-1">{{ selectedDomains()[0].title }}</strong>
          <span class="ms-1">domain.</span>
          } @else {
          <strong class="ms-1">{{ selectedDomains().length }}</strong>
          <span class="ms-1">domains:</span>
          @for (domain of selectedDomains(); track domain._id; let isLast = $last) {
          <strong class="ms-1">{{ domain.title }}</strong>@if (!isLast) {<span>,</span>}
          }
          }
        </span>
      </div>
      }

      <!-- Executive Summary -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h5 class="mb-3 d-flex align-items-center">
            <span class="material-symbols-rounded me-2">summarize</span>
            <span>Executive Summary</span>
          </h5>
          <p class="mb-0">{{ executiveSummary() }}</p>
        </div>
      </div>

      <!-- Policy Sections -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h5 class="mb-4">Policy Sections</h5>

          @for (section of policySections(); track section.id) {
          <div class="policy-section mb-4 pb-4 border-bottom">
            <h6 class="mb-3">{{ section.id }}. {{ section.title }}</h6>
            <p class="mb-3">{{ section.content }}</p>

            <div class="alert alert-light mb-2">
              <strong>Rationale:</strong> {{ section.rationale }}
            </div>

            <div class="references">
              <strong class="small text-muted">References:</strong>
              <ul class="list-unstyled ms-3 mt-1">
                @for (ref of section.references; track ref) {
                <li class="small d-flex align-items-center">
                  <span class="material-symbols-rounded me-1" style="font-size: 14px;">link</span>
                  <span>{{ ref }}</span>
                </li>
                }
              </ul>
            </div>
          </div>
          }
        </div>
      </div>

      <div class="alert alert-warning" role="alert">
        <strong>Note:</strong> This is a generated draft. Review and customize as needed before finalizing.
      </div>
    </div>
    }
  </div>
</div>

<!-- Analysis Type Selection Dialog -->
<app-dialog [open]="showAnalysisTypeDialog()" title="Select Analysis Type"
  description="Choose the type of analysis you want to perform for policy generation." width="500px"
  (closed)="closeAnalysisTypeDialog()">
  <div dialog-body>
    <div class="d-flex flex-column gap-3">
      <div class="form-check p-3 border rounded" [class.border-primary]="selectedAnalysisType === 'quick'"
        [class.bg-light]="selectedAnalysisType === 'quick'" style="cursor: pointer;"
        (click)="selectAnalysisType('quick')">
        <input class="form-check-input" type="radio" name="analysisType" id="analysisTypeQuick" value="quick"
          [checked]="selectedAnalysisType === 'quick'" (change)="selectAnalysisType('quick')">
        <label class="form-check-label w-100" for="analysisTypeQuick" style="cursor: pointer;">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <strong class="d-block mb-1">Quick Analysis</strong>
              <small class="text-muted">Faster generation with essential policy elements and basic
                recommendations.</small>
            </div>
            <span class="material-symbols-rounded text-primary ms-2">bolt</span>
          </div>
        </label>
      </div>

      <div class="form-check p-3 border rounded" [class.border-primary]="selectedAnalysisType === 'detailed'"
        [class.bg-light]="selectedAnalysisType === 'detailed'" style="cursor: pointer;"
        (click)="selectAnalysisType('detailed')">
        <input class="form-check-input" type="radio" name="analysisType" id="analysisTypeDetailed" value="detailed"
          [checked]="selectedAnalysisType === 'detailed'" (change)="selectAnalysisType('detailed')">
        <label class="form-check-label w-100" for="analysisTypeDetailed" style="cursor: pointer;">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <strong class="d-block mb-1">Detailed Analysis</strong>
              <small class="text-muted">Comprehensive analysis with in-depth policy sections, extensive rationale, and
                detailed references.</small>
            </div>
            <span class="material-symbols-rounded text-primary ms-2">insights</span>
          </div>
        </label>
      </div>
    </div>
  </div>

  <div dialog-footer>
    <!-- <app-button label="Cancel" variant="outline" (clicked)="closeAnalysisTypeDialog()"></app-button> -->
    <app-button label="Generate Policy" variant="primary" icon="auto_awesome"
      [disabled]="!selectedAnalysisType || isGenerating()" [loading]="isGenerating()"
      (clicked)="confirmAnalysisTypeAndGenerate()"></app-button>
  </div>
</app-dialog>

<!-- Full Screen Loading Overlay -->
@if (isGenerating()) {
<div class="policy-generation-overlay">
  <div class="policy-generation-content">
    <div class="spinner-container">
      <div class="spinner-ring">
        <div class="ring"></div>
        <div class="ring"></div>
        <div class="ring"></div>
      </div>
    </div>
    <div class="loading-text">
      <h3 class="mb-3">Generating Your Policy</h3>
      <p class="mb-2">Your policy is being generated and analyzed by AI</p>
      <p class="text-muted small">This may take a few moments...</p>
    </div>
    <div class="loading-steps">
      <div class="step-item">
        <span class="material-symbols-rounded">auto_awesome</span>
        <span>Analyzing assessments</span>
      </div>
      <div class="step-item">
        <span class="material-symbols-rounded">description</span>
        <span>Generating policy sections</span>
      </div>
      <div class="step-item">
        <span class="material-symbols-rounded">insights</span>
        <span>Creating recommendations</span>
      </div>
    </div>
  </div>
</div>
}